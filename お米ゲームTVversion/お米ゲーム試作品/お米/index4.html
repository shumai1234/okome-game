<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>turnOfSelling</title>
    <link rel="stylesheet" href="assets/commonStyle.css">
    <link rel="stylesheet" href="assets/style4.css">
</head>
<body>
    <h1>販売ターン</h1> 
    <div class="main">
    <figure class="presenter">
        <img src="assets/images/realFarmer.PNG" alt="販売者のイラスト">
    
        <h3>さぁさぁ売りだ！売りだ！売り切るぞぉー！</h3>
    
    <button id="selling1">客に売る！</button>
    </figure>
    </div>

    <section class="under">
    <hr>
    <h2>結果表示</h2>
    <section class="customerBox">
    <div id="result"></div>
    <figure><img class="customerImage" src="assets/images/woman1.PNG" alt="おばさん"></figure>
    </section>
    <h2 id="totalDisplay">ここに合計金額が表示されます</h2>

    <button onclick="location.href = 'index5.html'">次のページに進む</button>
    </section>
    <script>
      const selectedKind = localStorage.getItem('selectedKind');
      const selectedIndex = localStorage.getItem('selectedIndex');
      const selectedIndexNumber = Number(selectedIndex);
      const EconomyConditions = localStorage.getItem('EC');
      const container = document.getElementById('result');
      const selling = document.getElementById('selling1');
      const buyingSound = new Audio ('assets/sounds/buyingSound.mp3');
      //ページの再読み込みによる不正を防ぐためのコード
     let soldOut = localStorage.getItem('soldOut');

     //クリックの回数をカウントする変数
      let countOfClicks = 0;
      
    //米の売り上げの合計を出す
    let totalSales = 0;

// 確率判定と表示を行う共通関数
function checkSale(probability, customerIndex) {
    const randomNum = Math.floor(Math.random() * 100);
    const p = document.createElement('p');
    const priceList = [1000,700,450,300,200,100]//それぞれの米の販売価格リスト

    const customerImage = document.querySelector(".customerImage");
    customerImage.classList.remove('slideIn');//おばちゃんのリセット

    if (randomNum < probability) {
       //購入した場合の米の価格処理
       const price = priceList[selectedIndexNumber];
        totalSales += price;

        //購入者おばさん用アニメーション
        //customerImage（買い物客）のため
        
        setTimeout(()=>{
        buyingSound.pause()
        buyingSound.currentTime = 0;
        buyingSound.play()
         customerImage.classList.add('slideIn');
        }, 100);
        
        p.textContent = `${customerIndex}人目のお客様が${selectedKind}を購入しました！`;
    } else {
        p.textContent = `${customerIndex}人目のお客様は${selectedKind}を購入しませんでした。`;
    }
    container.appendChild(p);
   document.getElementById('totalDisplay').textContent = `合計売上金額: ${totalSales}円`;
   localStorage.setItem('totalSales', totalSales);
  
}



// 確率ごとの関数（iを引き継げるように修正）
function ten(i) { checkSale(11, i); }
function twenty(i) { checkSale(21, i); }
function thirty(i) { checkSale(31, i); }
function forty(i) { checkSale(41, i); }
function fifty(i) { checkSale(51, i); }
function sixty(i) { checkSale(61, i); }

//ページを開いたときに、画面の一番上に誘導するためのJS
window.onload = function() {
    window.scrollTo(0, 0);
};

selling.addEventListener('click',()=> {
    
    countOfClicks++;
    if (soldOut === 'true') {
        selling.disabled = true;
        return;
    }

    if (countOfClicks <= 5 ){
        let i = countOfClicks;
    // 実行前に結果表示エリアをクリアする場合（任意）
    //container.innerHTML = '';

        // コシヒカリ
        if (selectedIndexNumber === 0) {
            if (EconomyConditions === "超好景気") forty(i);
            else if (EconomyConditions === "好景気") thirty(i);
            else ten(i);
        }
        // 新之助
        else if (selectedIndexNumber === 1) {
            if (EconomyConditions === "超好景気") forty(i);
            else if (EconomyConditions === "好景気") fifty(i);
            else if (EconomyConditions === "普通") thirty(i);
            else ten(i);
        }
        // コシイブキ
        else if (selectedIndexNumber === 2) {
            if (EconomyConditions === "超好景気" || EconomyConditions === "好景気") forty(i);
            else if (EconomyConditions === "普通" || EconomyConditions === "不景気") twenty(i);
            else ten(i);
        }
        // はえぬき
        else if (selectedIndexNumber === 3) {
            if (EconomyConditions === "超好景気" || EconomyConditions === "好景気") thirty(i);
            else if (EconomyConditions === "普通") fifty(i);
            else if (EconomyConditions === "不景気") sixty(i);
            else forty(i);
        }
        // ズンズロー米
        else if (selectedIndexNumber === 4) {
            if (EconomyConditions === "超好景気") ten(i);
            else if (EconomyConditions === "好景気") twenty(i);
            else if (EconomyConditions === "普通") fifty(i);
            else sixty(i);
        }
        // 外国産米
        else if (selectedIndexNumber === 5) {
            if (EconomyConditions === "不景気") thirty(i);
            else if (EconomyConditions === "大不況") fifty(i);
            else ten(i);
        }
    } else{
        selling.disabled = true
    
        localStorage.setItem('soldOut', 'true');
    }

 
   
});
    
    </script>
</body>
</html>

